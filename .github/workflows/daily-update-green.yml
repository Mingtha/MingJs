name: daily-update-green

on:
    schedule:
        - cron: '0 2 * * *'
    workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
    update-green-rules:
        runs-on: ubuntu-latest

        steps:
            - name: Checkoutä»£ç 
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: è®¾ç½®Node.jsç¯å¢ƒ
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: è·å–å¹¶å¤„ç†Greenè§„åˆ™
              run: |
                  # è·å–æºæ–‡ä»¶å†…å®¹
                  echo "æ­£åœ¨è·å–æºæ–‡ä»¶..."
                  curl -s "https://raw.githubusercontent.com/QCEnjoyLL/Mihomo-Scripts/506f3ade6e5260606daba06ad8e3dc1dd784ff6d/green.yaml" -o green_source.yaml

                  # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æˆåŠŸä¸‹è½½
                  if [ ! -f "green_source.yaml" ] || [ ! -s "green_source.yaml" ]; then
                    echo "é”™è¯¯ï¼šæ— æ³•ä¸‹è½½æºæ–‡ä»¶æˆ–æ–‡ä»¶ä¸ºç©º"
                    exit 1
                  fi

                  echo "æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼Œå¼€å§‹å¤„ç†..."

                  # åˆ›å»ºå¤„ç†è„šæœ¬
                  cat > process_green.js << 'EOF'
                  const fs = require('fs');
                  const yaml = require('js-yaml');

                  try {
                    // è¯»å–æºæ–‡ä»¶
                    const sourceContent = fs.readFileSync('green_source.yaml', 'utf8');
                    
                    // è§£æYAML
                    const sourceData = yaml.load(sourceContent);
                    
                    // æå–payloadä¸­çš„è§„åˆ™
                    let rules = [];
                    if (sourceData && sourceData.payload) {
                      rules = sourceData.payload;
                    } else {
                      console.error('æºæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œæ‰¾ä¸åˆ°payloadå­—æ®µ');
                      process.exit(1);
                    }
                    
                    console.log(`æå–åˆ° ${rules.length} æ¡è§„åˆ™`);
                    
                    // ç”ŸæˆGreenClash.yamlæ ¼å¼
                    const clashData = {
                      payload: rules
                    };
                    const clashYaml = yaml.dump(clashData, {
                      lineWidth: -1,
                      noRefs: true,
                      quotingType: '"'
                    });
                    
                    // ç”ŸæˆGreenQX.listæ ¼å¼ï¼ˆå»æ‰å¼€å¤´çš„è¿å­—ç¬¦å’Œç©ºæ ¼ï¼‰
                    const qxList = rules.map(rule => rule.trim().replace(/^-\s*/, '')).join('\n');
                    
                    // å†™å…¥æ–‡ä»¶
                    fs.writeFileSync('rules/GreenClash.yaml', clashYaml);
                    fs.writeFileSync('rules/GreenQX.list', qxList);
                    
                    console.log('æ–‡ä»¶å¤„ç†å®Œæˆ');
                    console.log('GreenClash.yaml:', clashYaml.split('\n').length, 'è¡Œ');
                    console.log('GreenQX.list:', qxList.split('\n').length, 'è¡Œ');
                    
                  } catch (error) {
                    console.error('å¤„ç†æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯:', error);
                    process.exit(1);
                  }
                  EOF

                  # å®‰è£…ä¾èµ–å¹¶è¿è¡Œå¤„ç†è„šæœ¬
                  npm install js-yaml
                  node process_green.js

                  # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
                  rm -f green_source.yaml process_green.js

            - name: æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
              id: check_changes
              run: |
                  if git diff --quiet; then
                    echo "changes=false" >> $GITHUB_OUTPUT
                    echo "æ²¡æœ‰æ£€æµ‹åˆ°å˜æ›´"
                  else
                    echo "changes=true" >> $GITHUB_OUTPUT
                    echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
                  fi

            - name: æäº¤å˜æ›´
              if: steps.check_changes.outputs.changes == 'true'
              run: |
                  git config --local user.email "action@github.com"
                  git config --local user.name "GitHub Action"

                  # æ·»åŠ å˜æ›´çš„æ–‡ä»¶
                  git add rules/GreenClash.yaml rules/GreenQX.list

                  # è·å–å½“å‰æ—¶é—´
                  TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S UTC')

                  # æäº¤å˜æ›´
                  git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°Greenè§„åˆ™ - $TIMESTAMP"

                  # æ¨é€åˆ°è¿œç¨‹ä»“åº“
                  git push

                  echo "âœ… è§„åˆ™æ›´æ–°å®Œæˆå¹¶å·²æ¨é€åˆ°ä»“åº“"

            - name: è¾“å‡ºç»“æœ
              run: |
                  if [ "${{ steps.check_changes.outputs.changes }}" == "true" ]; then
                    echo "âœ… Greenè§„åˆ™å·²æˆåŠŸæ›´æ–°"
                    echo "ğŸ“Š æ›´æ–°çš„æ–‡ä»¶ï¼š"
                    echo "  - rules/GreenClash.yaml"
                    echo "  - rules/GreenQX.list"
                  else
                    echo "â„¹ï¸ è§„åˆ™æ— å˜æ›´ï¼Œè·³è¿‡æ›´æ–°"
                  fi
